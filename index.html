<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Bunyan Logging in Production at Joyent</title>

    <meta name="author" content="Trent Mick">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/trent.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
        if( window.location.search.match( /print-pdf/gi ) ) {
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'css/print/pdf.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        }
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>
<div class="reveal">
<div class="slides">

<section>
    <h1>Bunyan Logging in Production at Joyent</h1>
    <p>Trent Mick (@trentmick)</p>
    <p>Joyent</p>
</section>

<section>
    <h2>Bunyan Logging ...</h2>
    <ul>
        <li>Blow through usage and some features.</li>
    </ul>

    <h2>... in production at Joyent</h2>
    <ul>
        <li>Show a few (hopefully) interesting examples from production experiences.</li>
        <li>Discuss some motivations.</li>
    </ul>
</section>

<section>
    <h2>Bunyan is</h2>
    <p style="margin: 0 0 2em 1em">&#x2460 A node.js lib for structured service <small>(and CLI)</small> logging</p>

    <pre><code data-trim contenteditable>$ npm install bunyan
$ cat foo.js</code></pre>
    <pre><code data-trim contenteditable>
var bunyan = require('bunyan');
var log = bunyan.createLogger({
    name: 'foo',
    // ...
});

log.info('hi');

var err = new Error('ack');
log.error(err, 'boom!');
</code></pre>
</section>

<section>
    <h2>Bunyan is</h2>
    <p style="margin: 0 0 2em 1em">&#x2461 A (lightweight) JSON log format</p>

    <ul>
        <li>one line of JSON per record, small set of minimal fields:
        <pre><code data-trim contenteditable>{"name":"foo","hostname":"grape.local","pid":68313,"level":30,
    "msg":"hi","time":"2014-08-07T06:18:53.057Z","v":0}</code></pre>
        </li>
        <li>The primary audience of logs is machine processing.</li>
    </ul>
</section>

<section>
    <h2>Bunyan is</h2>
    <p style="margin: 0 0 2em 1em">&#x2462 A <code>bunyan</code> CLI for viewing and filtering logs</p>

    <p>Reading JSON sucks, but ANSI codes in files + custom parsing code suck
    more:
    <img width="850" height="193" src="./img/bunyan-cli-foo2.png" alt="Bunyan CLI example">

    <pre><code data-trim contenteditable>
bunyan foo.log [bar.log ...]
bunyan -l warn foo.log
bunyan -c 'this.user=="bob"' foo.log
</code></pre>
    </p>
</section>

<section>
    <h2>Bunyan features</h2>

    <ul>
    <li>standard levels: trace, debug, info, warn, error, fatal</li>
XXX
- elegant [log method API](#log-method-api)
- extensible [streams](#streams) system for controlling where log records
  go (to a stream, to a file, [log file rotation](#stream-type-rotating-file),
  etc.)
- [`bunyan` CLI](#cli-usage) for pretty-printing and filtering of Bunyan logs
- light-weight specialization of Logger instances with [`log.child`](#logchild)
- custom rendering of logged objects with ["serializers"](#serializers)
- [Runtime log snooping via DTrace support](#dtrace-support)
- simple include of log call source location (file, line, function) with
  [`src: true`](#src)
    </ul>

XXX link to README.md for more
</section>


<section>
    <div><img src="./img/logo.svg" width=300/>
    <img src="./img/sdc.png" width=350/>
    </div>

    <ul>
        <li>~40 service/agent/tool log types (~90% bunyan)</li>
        <li>1-5 service instances, one agent instance per server</li>
        <li>~12 DCs (counting test and staging DCs)</li>
    </ul>
</section>

<section>
    <h2>Motivation: Log more details</h2>

    <ul>
        <li>Make it convenient in code to log more and appropriate details.</li>
        <li>Painful, limited (traditional):
        <pre><code data-trim contenteditable>log.info('%s %s %s %s', req.method, req.url,
    res.statusCode, res.latency)</code></pre></li>
        <li>Easier to code (bunyan):
        <pre><code data-trim contenteditable>log.info({req: req}, 'received request');
log.debug({res: res}, 'responded');
log.error({err: err, path: path}, 'save failed');</code></pre></li>
    </ul>
</section>

<section>
    <section>
        <h2>Log more details: render nicely</h2>

        <p>Make having the extra details not a burden when browsing logs by
        rendering them nicely.</p>
    </section>
    <section>
        XXX screenshot with req
    </section>
    <section>
        XXX screenshot with res
    </section>
    <section>
        XXX screenshot with err
    </section>
    <section>
        XXX screenshot with chain
    </section>
</section>

<section>
    <h2>Log more details: filtering</h2>

    <p>Motivate logging of more structured details by making filtering
    convenient and compelling.</p>

    <pre><code data-trim contenteditable>
# ERROR level and above
$ bunyan foo.log -l error

# Watch incoming requests.
$ tail -f foo.log | bunyan -c 'this.req'

# Server errors in HTTP responses.
$ tail -f foo.log | bunyan -c 'this.res && this.res.statusCode >= 500'
</code></pre>
</section>

<section>
    <h2>Log more details: serializers</h2>

    <ul>
        <li>Problem: Dumping full objects -> extraneous goop in the logs.</li>
        <li>Define how an obj is logged with serializer functions for well-defined log <em>field names</em>.</li>
        <li>Bunyan defines for <code>err</code>, <code>req</code>, and <code>res</code>. Use is explicit, e.g.:
        <pre><code data-trim contenteditable>var log = bunyan.createLogger({
    //...
    serializers: {
        err: bunyan.stdSerializers.err,
        // custom
        user: function (u) { if (u) return {login: u.login, name: u.name}; }
    }
});

log.info({user: theUser}, 'logged in');
log.error({err: e, user: theUser}, 'logged failed');</code></pre>
        </li>
    </ul>
</section>

<section>
    XXX show full imgapi example
</section>

<section>
    <h2>Necessity: balancing volume</h2>

    <ul>
        <li>Serializers help limit the size of a logged object.</li>
        <li>Obviously, set runtime log level to control log volume.</li>
        <li>Not enough.</li>
        <li>Two interesting examples: RequestCaptureStream and DTrace.</li>
    </ul>
</section>

<section>
    <h2>Balancing volume: RequestCaptureStream</h2>

    <ul>
        <li>Provided by restify web service library.</li>
        <li>Store low level log records in in-memory ring buffer, <em>per request id</em>.</li>
        <li>If there is a <code>log.warn</code> or above, then all low level
        records for <em>for that request id</em> are logged.</li>
        <li>Used in Joyent's public web APIs.</li>
    </ul>
<!--
<pre><code data-trim contenteditable>var log = bunyan.createLogger({
    name: 'cloudapi',
    serializers: restify.bunyan.serializers,
    streams: [
        {
            level: 'info',
            stream: process.stderr
        },
        {
            type: 'raw',
            stream: new RequestCaptureStream({
                level: bunyan.WARN,
                maxRecords: 100,
                maxRequestIds: 100,
                streams: [ {
                    stream: process.stderr
                } ]
            })
        }
    ]
});
</code></pre>
-->
</section>

<section>
    <h2>Balancing volume: DTrace</h2>
    <ul>
        <li>XXX</li>
    </ul>
<!-- XXX dtrace demo would be nice -->
</section>

<section>
    <h2>Motivation: Tie things together</h2>
    <ul>
        <li>XXX</li>
    </ul>
</section>

<section>
    <h2>Tie things together: module-scope loggers don't help</h2>
    <ul>
        <li>XXX</li>
    </ul>
</section>

<section>
    <h2>Tie things together: always logging a context PITA</h2>
    <ul>
        <li>XXX</li>
    </ul>
</section>

<section>
    <h2>Tie things together: <code>log.child</code></h2>
    <ul>
        <li>XXX</li>
    </ul>
</section>

<section>
    <h2>Tie things together: <code>req_id</code></h2>
    <ul>
        <li>XXX</li>
    </ul>
</section>

<section>
    <h2>Tie things together: <code>req_id++</code></h2>
    <ul>
        <li>XXX</li>
    </ul>
</section>

<section>
    <h2>Tie things together: <code>req_id++</code></h2>
    <p>XXX Demo req_id group search.</p>
</section>

<section>
    <h2>Moar</h2>
    <ul>
        <li>XXX</li>
    </ul>
</section>

<section>
    <h2>Questions?</h2>

    <p style="margin-top: 2em;">Trent Mick<br>
    <a href="https://github.com/trentm/node-bunyan">github.com/trentm/node-bunyan</a><br>
    <a href="https://twitter.com/trentmick">@trentmick</a><br>
    <a href="https://groups.google.com/forum/?fromgroups#!forum/bunyan-logging">bunyan-logging@googlegroups.com</a>
    </p>
</section>

</div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.min.js"></script>

<script>
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
            { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
            { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
            { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
            { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
    });

</script>

</body>
</html>
